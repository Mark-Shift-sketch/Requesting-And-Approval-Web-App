<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Finance Dashboard</title>
    <link rel="stylesheet" href="/static/admin.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Make the form layout feel balanced */
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 22px;
        align-items: start;
      }

      /* Inputs */
      .form-group label {
        font-weight: 600;
        margin-bottom: 6px;
        display: block;
      }

      .form-group small {
        color: #6b7280;
        font-size: 12px;
      }

      /* Multi-select boxes: less tall, nicer */
      select[multiple] {
        min-height: 140px; /* reduce from very tall */
        border-radius: 12px;
        padding: 10px;
        border: 1px solid #e5e7eb;
        background: #fff;
      }

      /* Upload section: looks like a mini-card */
      .template-box {
        border: 1px dashed #d1d5db;
        border-radius: 14px;
        padding: 14px;
        background: #fafafa;
      }

      /* Primary button: more modern */
      .btn-primary {
        padding: 12px 18px;
        border-radius: 12px;
        font-weight: 700;
        box-shadow: 0 8px 18px rgba(37, 99, 235, 0.18);
      }

      /* Card spacing */
      .card {
        border-radius: 18px;
        padding: 22px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        align-items: start;
      }

      /* Make multi-select cleaner */
      select[multiple] {
        min-height: 150px;
        border-radius: 12px;
        padding: 10px;
        border: 1px solid #e5e7eb;
        background: white;
      }

      /* Upload box styling */
      .template-box {
        border: 1px dashed #d1d5db;
        border-radius: 14px;
        padding: 15px;
        background: #fafafa;
      }

      /* Button */
      .btn-primary {
        margin-top: 20px;
        padding: 12px 18px;
        border-radius: 12px;
        font-weight: 700;
        background: #2563eb;
        color: white;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <aside class="sidebar">
      <div class="sidebar-header">
        <i
          class="fa-solid fa-building-columns"
          style="color: white; font-size: 1.125rem"
        ></i>
        <h1 class="logo-text">Finance</h1>
      </div>

      <nav class="sidebar-nav custom-scrollbar">
        <a
          id="nav-dashboard"
          class="nav-item active"
          onclick="switchView('dashboard')"
        >
          <div class="nav-item-content">
            <i class="fa-solid fa-border-all"></i>
            <span>Dashboard</span>
          </div>
        </a>

        <a
          id="nav-notifications"
          class="nav-item"
          onclick="switchView('notifications')"
        >
          <div class="nav-item-content">
            <i class="fa-regular fa-bell"></i>
            <span>Notifications</span>
          </div>
        </a>

        {% if session['role'] == 'Admin' %}
        <a id="nav-requests" class="nav-item" onclick="switchView('requests')">
          <div class="nav-item-content">
            <i class="fa-solid fa-file-invoice-dollar"></i>
            <span style="line-height: 1.2">Request Type<br />Management</span>
          </div>
        </a>
        {% endif %}
      </nav>

      <div class="sidebar-footer">
        <div style="padding: 0 20px 10px 20px; color: #9ca3af; font-size: 12px">
          Logged in as: <br />
          <strong style="color: white">{{ session['role'] }}</strong><br />
          <span style="color: #6b7280">{{ session['position'] }}</span>
        </div>
        <a href="/logout" class="logout-link">
          <i
            class="fa-solid fa-arrow-right-from-bracket"
            style="margin-right: 12px"
          ></i>
          <span>Logout</span>
        </a>
      </div>
    </aside>

    <main class="main-content">
      <div id="view-dashboard" class="view-section">
        <header class="top-header">
          <div class="header-title">
            <h2>{{ session['role'] }} Dashboard</h2>
            <p>Welcome back, {{ session['email'] }}</p>
          </div>

          <div class="header-actions">
            <div class="date-widget">
              <i class="fa-regular fa-calendar" style="margin-right: 8px"></i>
              <span class="current-date-display"></span>
            </div>
          </div>
        </header>

        <div class="content-scroll custom-scrollbar">
          <div class="stats-grid">
            <div class="stat-card card-blue">
              <div class="stat-header">
                <div class="icon-box">
                  <i class="fa-regular fa-calendar-check"></i>
                </div>
              </div>
              <div>
                <h3 class="stat-value">{{ approvals_today }}</h3>
                <p class="stat-label">Approvals Today</p>
              </div>
            </div>

            <div class="stat-card card-yellow">
              <div class="stat-header">
                <div class="icon-box"><i class="fa-regular fa-clock"></i></div>
              </div>
              <div>
                <h3 class="stat-value">{{ pending_count }}</h3>
                <p class="stat-label">Pending Approvals</p>
              </div>
            </div>

            <div class="stat-card card-green">
              <div class="stat-header">
                <div class="icon-box"><i class="fa-solid fa-check"></i></div>
              </div>
              <div>
                <h3 class="stat-value">{{ approved_count }}</h3>
                <p class="stat-label">Total Approved</p>
              </div>
            </div>

            <div class="stat-card card-red">
              <div class="stat-header">
                <div class="icon-box"><i class="fa-solid fa-xmark"></i></div>
              </div>
              <div>
                <h3 class="stat-value">{{ rejected_count }}</h3>
                <p class="stat-label">Total Rejected</p>
              </div>
            </div>
          </div>

          <div class="card-container">
            <div class="table-header">
              <div class="table-title">
                {% if session['role'] == 'Admin' %}
                <h3>All System Requests</h3>
                {% else %}
                <h3>Requests Assigned to You</h3>
                {% endif %}
                <span class="count-badge" id="table-count-badge"
                  >{{ recent_requests|length }}</span
                >
              </div>

              <div class="table-actions">
                <div class="search-box">
                  <i class="fa-solid fa-search"></i>
                  <input
                    type="text"
                    id="search-input"
                    placeholder="Search..."
                    class="search-input"
                    onkeyup="filterTable()"
                  />
                </div>
                <select
                  id="status-filter"
                  class="filter-select"
                  onchange="filterTable()"
                >
                  <option value="">All Status</option>
                  <option value="Pending">Pending</option>
                  <option value="Approved">Approved</option>
                  <option value="Rejected">Rejected</option>
                </select>
              </div>
            </div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Request ID</th>
                    <th>Email</th>
                    <th>Department</th>
                    <th>Request Type</th>
                    <th>Attachment</th>
                    <th>Status</th>
                    <th class="text-right">Action</th>
                  </tr>
                </thead>
                <tbody id="requests-table-body">
                  {% if recent_requests %} {% for req in recent_requests %}
                  <tr class="request-row" data-status="{{ req.status_name }}">
                    <td>#{{ req.request_id }}</td>
                    <td>
                      <div class="user-info-cell">
                        <span class="user-email">{{ req.email }}</span>
                      </div>
                    </td>
                    <td>{{ req.dept_name }}</td>
                    <td><span class="type-badge">{{ req.type_name }}</span></td>
                    <td>
                      {% if req.filename %}
                      <a
                        href="/download_attachment/{{ req.request_id }}"
                        target="_blank"
                        class="file-link"
                      >
                        <i class="fa-solid fa-paperclip"></i> {{ req.filename }}
                      </a>
                      {% else %}
                      <span class="text-muted">No file</span>
                      {% endif %}
                    </td>
                    <td>
                      <span
                        class="status-badge status-{{ req.status_name|lower }}"
                        >{{ req.status_name }}</span
                      >
                    </td>
                    <td class="text-right">
                      {% if req.status_name == 'PENDING' %}
                      <div class="action-group">
                        <button
                          class="btn-icon btn-approve"
                          title="Approve"
                          onclick="updateStatus('{{ req.request_id }}', 'approved')"
                        >
                          <i class="fa-solid fa-check"></i>
                        </button>
                        <button
                          class="btn-icon btn-reject"
                          title="Reject"
                          onclick="rejectRequest('{{ req.request_id }}')"
                        >
                          <i class="fa-solid fa-xmark"></i>
                        </button>
                      </div>
                      {% else %}
                      <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %} {% else %}
                  <tr>
                    <td
                      colspan="7"
                      style="text-align: center; color: #6b7280; padding: 20px"
                    >
                      No requests found.
                    </td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      {% if session['role'] == 'Admin' %}
      <div id="view-requests" class="view-section" style="display: none">
        <header class="top-header">
          <div class="header-title">
            <h2>Request Type Management</h2>
          </div>
          <div class="header-actions">
            <div class="date-widget">
              <i class="fa-regular fa-calendar" style="margin-right: 8px"></i>
              <span class="current-date-display"></span>
            </div>
          </div>
        </header>

        <div class="content-scroll custom-scrollbar">
          <div class="card-container form-section">
            <div class="section-header">
              <h3>Add Request Type</h3>
            </div>
            <form
              action="/add_request_type"
              method="POST"
              enctype="multipart/form-data"
              class="form-grid"
            >
              <div class="form-group">
                <label class="form-label">Type Name</label>
                <input
                  type="text"
                  name="type_name"
                  placeholder="e.g. Budget Approval"
                  class="form-control"
                  required
                />
              </div>

              <div class="form-group" style="grid-column: span 2">
                <label class="form-label">Reviewer Positions</label>
                <p style="font-size: 12px; color: gray; margin-bottom: 5px">
                  Select one or more reviewers (review happens before
                  approvers). Hold Ctrl (Windows) or Cmd (Mac) to select
                  multiple.
                </p>
                <select
                  name="reviewer_position_ids[]"
                  class="form-control"
                  multiple
                  size="6"
                >
                  {% for pos in positions %}
                  <option value="{{ pos.position_id }}">
                    {{ pos.position_name }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group" style="grid-column: span 2">
                <label class="form-label">Approver Positions</label>
                <p style="font-size: 12px; color: gray; margin-bottom: 5px">
                  Select one or more approvers. Hold Ctrl (Windows) or Cmd (Mac)
                  to select multiple.
                </p>
                <select
                  name="approver_position_ids[]"
                  class="form-control"
                  multiple
                  size="6"
                  required
                >
                  {% for pos in positions %}
                  <option value="{{ pos.position_id }}">
                    {{ pos.position_name }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group" style="grid-column: span 2">
                <label class="form-label"
                  >Upload Template Form (Optional)</label
                >
                <p style="font-size: 12px; color: gray; margin-bottom: 5px">
                  Upload a Word/PDF/Excel file for users to fill out.
                </p>
                <input
                  type="file"
                  name="template_file"
                  class="form-control"
                  style="padding: 5px"
                />
              </div>

              <div style="grid-column: span 2">
                <button type="submit" class="btn-primary">
                  Add Type & Template
                </button>
              </div>
            </form>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Type Name</th>
                  <th>Template</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for type in existing_types %}
                <tr>
                  <td>{{ type.type_name }}</td>
                  <td>
                    {% if type.template_filename %}
                    <span style="color: green; font-size: 12px"
                      ><i class="fa-solid fa-file"></i> {{
                      type.template_filename }}</span
                    >
                    {% else %}
                    <span style="color: gray; font-size: 12px">None</span>
                    {% endif %}
                  </td>
                  <td>... (actions) ...</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="card-container">
            <div
              class="table-header"
              style="border-bottom: 1px solid var(--border-color)"
            >
              <div class="section-title"><h3>Existing Request Types</h3></div>
            </div>

            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Type Name</th>
                    <th>Reviewers</th>
                    <th>Approvers</th>
                    <th class="text-right">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% if existing_types %} {% for type in existing_types %}
                  <tr>
                    <td>#{{ type.request_type_id }}</td>
                    <td>{{ type.type_name }}</td>
                    <td>
                      <span class="role-badge"
                        >{{ type.reviewer_names if type.reviewer_names else
                        'None' }}</span
                      >
                    </td>
                    <td>
                      <span class="role-badge"
                        >{{ type.approver_names if type.approver_names else
                        'None' }}</span
                      >
                    </td>
                    <td class="text-right">
                      <div class="action-group">
                        <button
                          class="action-icon-btn"
                          onclick="openEditModal('{{ type.request_type_id }}', '{{ type.type_name }}', '{{ type.reviewer_ids }}', '{{ type.approver_ids }}')"
                          title="Edit"
                        >
                          <i class="fa-regular fa-pen-to-square"></i>
                        </button>
                        <button
                          class="action-icon-btn icon-delete"
                          onclick="confirmDelete('{{ type.request_type_id }}', '{{ type.type_name }}')"
                          title="Delete"
                        >
                          <i class="fa-regular fa-trash-can"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                  {% endfor %} {% else %}
                  <tr>
                    <td colspan="5" style="text-align: center; padding: 20px">
                      No request types found.
                    </td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <div id="view-notifications" class="view-section" style="display: none">
        <header class="top-header">
          <div class="header-title"><h2>Notifications</h2></div>
          <div class="header-actions">
            <div class="date-widget">
              <i class="fa-regular fa-calendar" style="margin-right: 8px"></i>
              <span class="current-date-display"></span>
            </div>
          </div>
        </header>

        <div class="content-scroll custom-scrollbar">
          <div class="card-container">
            <div class="table-header">
              <div class="section-title"><h3>All Activity</h3></div>
              <a
                href="#"
                class="mark-read-link"
                onclick="alert('Feature coming soon')"
                >Mark all as read</a
              >
            </div>
            <div class="notification-list">
              <div style="text-align: center; color: #6b7280; padding: 20px">
                No new notifications.
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div
      id="editModal"
      class="modal-overlay"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      "
    >
      <div
        class="modal-content"
        style="
          background: white;
          padding: 2rem;
          border-radius: 12px;
          width: 400px;
        "
      >
        <h3 style="margin-bottom: 1.5rem">Edit Request Type</h3>
        <form action="/edit_request_type" method="POST">
          <input type="hidden" name="type_id" id="edit_type_id" />
          <div class="form-group" style="margin-bottom: 1rem">
            <label class="form-label">Request Name</label>
            <input
              type="text"
              name="type_name"
              id="edit_type_name"
              class="form-control"
              required
              style="width: 100%"
            />
          </div>
          {% if positions %}
          <div class="form-group" style="margin-bottom: 1rem">
            <label class="form-label">Reviewer Positions</label>
            <p style="font-size: 12px; color: #6b7280; margin: 6px 0 8px">
              Hold Ctrl/Cmd to select multiple.
            </p>
            <select
              name="reviewer_position_ids[]"
              id="edit_reviewer_ids"
              class="form-control"
              multiple
              size="6"
              style="width: 100%"
            >
              {% for pos in positions %}
              <option value="{{ pos.position_id }}">
                {{ pos.position_name }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 1.5rem">
            <label class="form-label">Approver Positions</label>
            <p style="font-size: 12px; color: #6b7280; margin: 6px 0 8px">
              Hold Ctrl/Cmd to select multiple.
            </p>
            <select
              name="approver_position_ids[]"
              id="edit_approver_ids"
              class="form-control"
              multiple
              size="6"
              style="width: 100%"
            >
              {% for pos in positions %}
              <option value="{{ pos.position_id }}">
                {{ pos.position_name }}
              </option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
          <div style="display: flex; gap: 10px; justify-content: flex-end">
            <button
              type="button"
              onclick="closeEditModal()"
              class="btn-secondary"
            >
              Cancel
            </button>
            <button type="submit" class="btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // --- Initialization ---
    window.onload = function () {
        const dateOptions = {
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric",
        };
        const today = new Date().toLocaleDateString("en-US", dateOptions);
        document
        .querySelectorAll(".current-date-display")
        .forEach((el) => (el.innerText = today));
    };

      // --- Navigation ---
    function switchView(viewName) {
        document
        .querySelectorAll(".view-section")
        .forEach((el) => (el.style.display = "none"));
        document
        .querySelectorAll(".nav-item")
        .forEach((el) => el.classList.remove("active"));
        document.getElementById(`view-${viewName}`).style.display = "flex";
        document.getElementById(`nav-${viewName}`).classList.add("active");
    }

      // --- Client-Side Table Filtering ---
    function filterTable() {
        const searchQuery = document
        .getElementById("search-input")
        .value.toLowerCase();
        const statusFilter = document
        .getElementById("status-filter")
        .value.toLowerCase();
        const rows = document.querySelectorAll(
        "#requests-table-body tr.request-row",
        );

        rows.forEach((row) => {
        const text = row.innerText.toLowerCase();
        const status = row.getAttribute("data-status").toLowerCase();
        const matchesSearch = text.includes(searchQuery);
        const matchesStatus = statusFilter === "" || status === statusFilter;
        row.style.display = matchesSearch && matchesStatus ? "" : "none";
        });
    }

      // --- Actions (Approve/Reject) ---
    function rejectRequest(requestId) {
        const reason = prompt("Please enter the reason for rejection:");
        if (reason === null) return;
        if (reason.trim() === "") {
        alert("Rejection reason is required.");
        return;
        }
        updateStatus(requestId, "rejected", reason);
    }

    async function updateStatus(requestId, status, message = "") {
        if (!confirm(`Mark request #${requestId} as ${status.toUpperCase()}?`))
        return;

        try {
        const response = await fetch(`/api/request/${requestId}/status`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: status, message: message }),
        });

        const result = await response.json();
        if (response.ok) {
            alert("Success: " + result.message);
            location.reload();
        } else {
            alert("Error: " + (result.error || "Unknown error"));
        }
        } catch (error) {
        console.error("Error:", error);
        alert("Network error. Failed to update status.");
        }
    }

      // --- Modals ---
    function openEditModal(id, name, reviewerCsv, approverCsv) {
        document.getElementById("edit_type_id").value = id;
        document.getElementById("edit_type_name").value = name;

        // Set multi-select values
        const reviewers = (reviewerCsv || "")
        .toString()
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean);
        const approvers = (approverCsv || "")
        .toString()
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean);

        const reviewerSel = document.getElementById("edit_reviewer_ids");
        const approverSel = document.getElementById("edit_approver_ids");

        if (reviewerSel) {
        [...reviewerSel.options].forEach(
            (opt) => (opt.selected = reviewers.includes(opt.value)),
        );
        }
        if (approverSel) {
        [...approverSel.options].forEach(
            (opt) => (opt.selected = approvers.includes(opt.value)),
        );
        }

        document.getElementById("editModal").style.display = "flex";
    }

    function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
    }

    function confirmDelete(typeId, typeName) {
        if (confirm(`Delete request type "${typeName}"?`)) {
        window.location.href = `/delete_request_type/${typeId}`;
    }
    }

    window.onclick = function (event) {
        const modal = document.getElementById("editModal");
        if (event.target == modal) closeEditModal();
    };
    </script>
</body>
</html>
